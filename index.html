<!DOCTYPE html>
 <html lang="de">
 <head>
     <meta charset="UTF-8">
     <title>Bilderklassifikation mit MobileNet und p5.js</title>
     <link rel="stylesheet" href="app.css">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
     <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
 </head>
 <body>
     <h1>Bilderklassifikation mit MobileNet und p5.js</h1>
     <div id="classifiedCorrectly">
         <h2>Richtig klassifizierte Bilder</h2>
     </div>
     <div id="classifiedIncorrectly">
         <h2>Falsch klassifizierte Bilder</h2>
     </div>
     <div id="dropArea">Ziehen Sie ein Bild hierher oder klicken Sie, um auszuwählen.</div>
     <button id="classifyButton" onclick="classifyImage()">Classify</button>
     <div id="interactionButtons" style="display: none;">
         <button onclick="markCorrect()">Richtig</button>
         <button onclick="markIncorrect()">Falsch</button>
     </div>
     <div id="resultSection">
         <div id="imageSection"></div>
         <div id="resultContainer"></div>
     </div>
     <script src="main.js"></script>
 </body>
 </html>
 let classifier;
 let imageElement;
 let imageThumbnail; // Thumbnail des aktuellen Bildes
 let lastResult; // Speichert das letzte Klassifikationsergebnis
 let correctClassifications = [];
 let incorrectClassifications = [];

 function setup() {
     noCanvas();
     classifier = ml5.imageClassifier('MobileNet', modelLoaded);
     const dropArea = select('#dropArea');
     dropArea.dragOver(() => dropArea.style('background-color', '#ccc'));
     dropArea.dragLeave(() => dropArea.style('background-color', '#fff'));
     dropArea.drop(handleFile, () => dropArea.style('background-color', '#fff'));
 }

 function modelLoaded() {
     console.log('Model geladen!');
 }

 function handleFile(file) {
     if (file.type === 'image') {
         imageElement = createImg(file.data, '').hide();
         imageElement.size(400, 400); // Anpassung an feste Größe des Drop-Bereichs
         const dropArea = select('#dropArea');
         dropArea.html('');
         imageElement.parent(dropArea);
         imageElement.show();
     } else {
         console.log('Nicht unterstützter Dateityp');
     }
 }

 function classifyImage() {
     if (imageElement) {
         classifier.classify(imageElement, gotResult);
         imageElement.hide(); // Verberge Bild im Drop-Bereich nach der Klassifikation
     }
 }

 function gotResult(error, results) {
     if (error) {
         console.error(error);
     } else {
         const confidence = results[0].confidence * 100;
         const label = results[0].label;

         // Thumbnail für Ergebnisbereich erstellen und altes Thumbnail ersetzen
         if (imageThumbnail) {
           imageThumbnail.remove();
         }
         imageThumbnail = createImg(imageElement.elt.src, '').hide();
         imageThumbnail.size(100, 100); // Größe des Thumbnails anpassen
         imageThumbnail.parent('imageSection'); // Thumbnail zum Ergebnisbereich hinzufügen
         imageThumbnail.show();

         lastResult = { src: imageElement.elt.src, label: label, confidence: confidence };
         const resultContainer = select('#resultContainer');
         resultContainer.html(generateResultTable(label, confidence));

         select('#interactionButtons').style('display', 'block'); // Zeige Interaktionsbuttons
     }
 }

 function generateResultTable(label, confidence) {
     return `
         <table>
             <tr>
                 <td><img src="${imageElement.elt.src}" style="width: 100px;"></td>
                 <td>
                     <div>${label}</div>
                     <div class="custom-bar">
                         <div class="confidence-bar" style="width:${confidence * 4}px;"></div>
                         <div class="confidence-text">${Math.round(confidence)}%</div>
                     </div>
                 </td>
             </tr>
         </table>
     `;
 }

 function markCorrect() {
     if (correctClassifications.length >= 3) correctClassifications.shift();
     correctClassifications.push(lastResult);
     updateClassificationsDisplay();
 }

 function markIncorrect() {
     if (incorrectClassifications.length >= 3) incorrectClassifications.shift();
     incorrectClassifications.push(lastResult);
     updateClassificationsDisplay();
 }

 function updateClassificationsDisplay() {
     updateClassificationTable('#classifiedCorrectly', correctClassifications);
     updateClassificationTable('#classifiedIncorrectly', incorrectClassifications);
 }

 function updateClassificationTable(selector, classifications) {
     const section = select(selector);
     section.html('<h2>' + (selector.includes('Correct') ? 'Richtig' : 'Falsch') + ' klassifizierte Bilder</h2>');
     classifications.forEach(result => {
         section.child(createElement('table', generateResultTable(result.label, result.confidence)).style('width', '100%'));
     });
 }
